# 安全支付解决方案

## 问题
Agent 需要调用智能合约付款，但不想在服务器上暴露私钥。

## 解决方案对比

### 方案 1: 独立签名服务（推荐）⭐
**优点：**
- 私钥隔离，服务器不存储私钥
- 可以设置访问控制
- 易于审计和监控
- 支持多环境部署

**缺点：**
- 需要额外的服务
- 需要网络通信

**架构：**
```
Agent 服务器 → 签名服务 API → 签名交易 → 返回签名 → Agent 广播交易
```

### 方案 2: 元交易/中继器模式
**优点：**
- 用户签名，服务器中继
- 用户控制私钥
- 服务器无需私钥

**缺点：**
- 需要用户交互（签名）
- 不适合自动化场景

### 方案 3: 账户抽象（ERC-4337）
**优点：**
- 使用智能合约钱包
- 支持社交恢复
- 更灵活

**缺点：**
- 需要部署智能合约钱包
- 复杂度较高

### 方案 4: 托管钱包服务
**优点：**
- 专业安全团队
- 合规性支持

**缺点：**
- 需要付费
- 依赖第三方

## 推荐实现：独立签名服务

已实现完整的签名服务方案，包括：

1. **签名服务** (`/api/payment/sign`)
   - 存储私钥（环境变量或密钥管理服务）
   - 签名交易
   - 返回签名后的交易

2. **广播服务** (`/api/payment/broadcast`)
   - 接收签名后的交易
   - 广播到区块链
   - 不存储私钥

3. **工具函数** (`/api/payment/utils.ts`)
   - `makeContractPayment()` - 调用智能合约支付
   - `makeDirectPayment()` - 直接转账

## 使用方式

### 在 Agent 中调用支付

```typescript
import { makeContractPayment } from '@/app/api/payment/utils';

// 智能合约支付
const result = await makeContractPayment(
  '0x316fb57ae002066a406c649c42ed33d04ac0c8f2',
  '0.01',
  '支付描述'
);
```

## 安全建议

1. **生产环境部署**
   - 签名服务部署在独立服务器
   - 使用密钥管理服务（AWS KMS、HashiCorp Vault 等）
   - 添加 IP 白名单
   - 添加 API Key 认证

2. **监控和审计**
   - 记录所有签名操作
   - 监控异常交易
   - 设置交易限制

3. **高安全要求**
   - 考虑使用硬件安全模块（HSM）
   - 使用多签钱包
   - 实现交易审批流程
